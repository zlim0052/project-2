<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.jsdelivr.net/npm/vega@5.22.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.20.8"></script>
  <style>
    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #dropdown-container {
      margin: 20px;
      text-align: center;
    }
    #vis {
      flex-grow: 1;
    }
    #title {
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      margin-top: 10px;
    }
    #description {
      text-align: center;
      font-size: 16px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div id="dropdown-container">
    <label for="metric-select">Select Metric:</label>
    <select id="metric-select">
      <option value="LSS1 Projects">LSS1 Projects</option>
      <option value="LSS1 Capacity (MW)">LSS1 Capacity (MW)</option>
      <option value="LSS2 Projects">LSS2 Projects</option>
      <option value="LSS2 Capacity (MW)">LSS2 Capacity (MW)</option>
    </select>
  </div>

  <div id="title">LSS1 Projects</div>
  <div id="description">This map shows the number of LSS1 Projects by state. The darker red regions indicate higher numbers of projects.</div>
  <div id="vis"></div>

  <script>
    const metricDetails = {
      "LSS1 Projects": {
        "title": "LSS1 Projects",
        "description": "This map shows the number of LSS1 Projects by state. The darker red regions indicate higher numbers of projects."
      },
      "LSS1 Capacity (MW)": {
        "title": "LSS1 Capacity (MW)",
        "description": "This map shows the total capacity (MW) of LSS1 Projects by state. Higher capacity regions are shown in darker red."
      },
      "LSS2 Projects": {
        "title": "LSS2 Projects",
        "description": "This map shows the number of LSS2 Projects by state. The darker red regions indicate higher numbers of projects."
      },
      "LSS2 Capacity (MW)": {
        "title": "LSS2 Capacity (MW)",
        "description": "This map shows the total capacity (MW) of LSS2 Projects by state. Higher capacity regions are shown in darker red."
      }
    };

    const baseSpec = {
      "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
      "width": "container",
      "height": "container",
      "projection": {"type": "equalEarth"},
      "data": {
        "url": "https://raw.githubusercontent.com/mptwaktusolat/jakim.geojson/refs/heads/master/malaysia.state.geojson",
        "format": {"type": "json", "property": "features"}
      },
      "transform": [
        {
          "lookup": "properties.name",  // Field in GeoJSON
          "from": {
            "data": {
              "url": "https://raw.githubusercontent.com/zlim0052/project-2/refs/heads/main/cleaned_lss_data_corrected.csv",
              "format": {"type": "csv"}
            },
            "key": "State",  // Field in CSV
            "fields": ["LSS1 Projects", "LSS1 Capacity (MW)", "LSS2 Projects", "LSS2 Capacity (MW)"]
          }
        },
        {
          "calculate": "datum['LSS1 Projects'] == null ? 0 : datum['LSS1 Projects']",  // Fill null values
          "as": "LSS1 Projects"
        }
      ],
      "layer": [
        {
          "mark": {"type": "geoshape", "fill": "lightgray", "stroke": "white"},
          "encoding": {
            "tooltip": {
              "field": "properties.name",
              "type": "nominal",
              "title": "State"
            }
          }
        },
        {
          "mark": {"type": "geoshape", "stroke": "white"},
          "encoding": {
            "color": {
              "field": "LSS1 Projects",  // Default field for color
              "type": "quantitative",
              "scale": {
                "type": "linear",
                "domain": [0, 75],  // Domain of the data
                "range": ["#fff5f0", "#67000d"],  // Light red to dark red
                "steps": 75  // 50 steps in the saturation scale
              }
            },
            "tooltip": [
              {"field": "properties.name", "type": "nominal", "title": "State"},
              {"field": "LSS1 Projects", "type": "quantitative", "title": "LSS1 Projects"},
              {"field": "LSS1 Capacity (MW)", "type": "quantitative", "title": "LSS1 Capacity (MW)"},
              {"field": "LSS2 Projects", "type": "quantitative", "title": "LSS2 Projects"},
              {"field": "LSS2 Capacity (MW)", "type": "quantitative", "title": "LSS2 Capacity (MW)"}
            ]
          }
        }
      ]
    };

    function updateSpec(selectedMetric) {
      // Update the title and description based on the selected metric
      document.getElementById('title').innerText = metricDetails[selectedMetric].title;
      document.getElementById('description').innerText = metricDetails[selectedMetric].description;

      // Update the visualization based on the selected metric
      const updatedSpec = JSON.parse(JSON.stringify(baseSpec));
      updatedSpec.layer[1].encoding.color.field = selectedMetric;
      updatedSpec.layer[1].encoding.tooltip[1].field = selectedMetric;
      updatedSpec.layer[1].encoding.tooltip[1].title = selectedMetric;
      vegaEmbed("#vis", updatedSpec, {mode: "vega-lite"}).then(result => {
        const view = result.view;

        view.runAfter(() => {
          const data = view.data("source_0");  // Check the dataset
          console.log('Loaded Data:', data);  // Log the loaded data
        });
      }).catch(console.warn);
    }

    // Initial render
    updateSpec("LSS1 Projects");

    // Add event listener to the dropdown
    document.getElementById('metric-select').addEventListener('change', function(event) {
      const selectedMetric = event.target.value;
      updateSpec(selectedMetric);
    });
  </script>
</body>
</html>
